---
description: Exception Handling Standards (Python 3.13, ExceptionGroup, add_note)
globs: **/*.py
alwaysApply: false
---

# ğŸ›‘ Modern Exception Handling Standards (2026)

## 1. Exception Hierarchy (Domain-Driven)
- **Base Class:** ëª¨ë“  ì»¤ìŠ¤í…€ ì˜ˆì™¸ëŠ” `TradingError`ë¥¼ ìƒì†ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
- **Categorization:** ì˜ˆì™¸ì˜ ì„±ê²©ì— ë”°ë¼ ëª…í™•íˆ êµ¬ë¶„í•©ë‹ˆë‹¤.
    - `InfrastructureError`: DB ì—°ê²° ì‹¤íŒ¨, íŒŒì¼ I/O ì˜¤ë¥˜ (ì¬ì‹œë„ ëŒ€ìƒ)
    - `ExchangeError`: API íƒ€ì„ì•„ì›ƒ, 429 Rate Limit (ì¬ì‹œë„/ëŒ€ê¸° ëŒ€ìƒ)
    - `StrategyError`: ë¡œì§ ë²„ê·¸, ì˜ëª»ëœ ì‹œê·¸ë„, ë°ì´í„° ì •í•©ì„± ê¹¨ì§ (ì¤‘ë‹¨ ëŒ€ìƒ)
    - `CriticalError`: í‚¤ ìœ ì¶œ ì˜ì‹¬, ìì‚° ì¦ë°œ ìœ„í—˜ (ì¦‰ì‹œ Kill Switch)

## 2. Python 3.13 Modern Syntax
- **Context Enrichment (`add_note`):** ì˜ˆì™¸ë¥¼ ìƒìœ„ë¡œ ì „íŒŒ(`re-raise`)í•  ë•Œ, ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ëŠ” ëŒ€ì‹  `e.add_note("Context info...")`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - ì´ëŠ” ì›ë³¸ Tracebackì„ ë³´ì¡´í•˜ë©´ì„œ ë””ë²„ê¹… ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” í‘œì¤€ ë°©ì‹ì…ë‹ˆë‹¤.
- **Exception Groups (`except*`):** `asyncio.TaskGroup` ì‚¬ìš© ì‹œ ë°œìƒí•˜ëŠ” ë‹¤ì¤‘ ì˜ˆì™¸ëŠ” ë°˜ë“œì‹œ `except*` (ExceptionGroup) ë¬¸ë²•ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.

## 3. Handling Policy (Retry vs Fail)
- **Recoverable (Retry):** ë„¤íŠ¸ì›Œí¬/ì¸í”„ë¼ ì˜¤ë¥˜ëŠ” `tenacity` ë¼ì´ë¸ŒëŸ¬ë¦¬ ë“±ì„ ì‚¬ìš©í•´ ì§€ìˆ˜ ë°±ì˜¤í”„(Exponential Backoff)ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.
- **Unrecoverable (Fail Fast):** ë¡œì§ ì˜¤ë¥˜ë‚˜ `CriticalError`ëŠ” ì ˆëŒ€ ìˆ¨ê¸°ì§€ ë§ê³ (`pass` ê¸ˆì§€), ì¦‰ì‹œ í”„ë¡œê·¸ë¨ì„ ì¤‘ë‹¨ì‹œí‚¤ê±°ë‚˜ ì•ˆì „ ëª¨ë“œë¡œ ì „í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

## 4. Integration with Notification
- **Alert Hook:** `CriticalError`ë‚˜ ì²˜ë¦¬ë˜ì§€ ì•Šì€ `ExchangeError` ë°œìƒ ì‹œ, ë°˜ë“œì‹œ Rule #22(Notification)ì˜ **ì—ëŸ¬ ì±„ë„ Webhook**ì„ íŠ¸ë¦¬ê±°í•´ì•¼ í•©ë‹ˆë‹¤.

## 5. Example Pattern

### âœ… Good (Modern & Contextual)
```python
import asyncio
from src.core.exceptions import TradingError, CriticalError

async def fetch_price(symbol: str):
    try:
        # ... logic ...
        raise ConnectionError("Connection reset")
    except Exception as e:
        # Python 3.11+ ë°©ì‹: ì›ë³¸ ì—ëŸ¬ì— ë§¥ë½ ì¶”ê°€
        e.add_note(f"Failed while fetching {symbol}")
        raise # ê·¸ëŒ€ë¡œ ë˜ì§

async def main_loop():
    try:
        async with asyncio.TaskGroup() as tg:
            tg.create_task(fetch_price("BTC"))
            tg.create_task(fetch_price("ETH"))
            
    except* ConnectionError as eg: # ExceptionGroup ì²˜ë¦¬
        # ì—¬ëŸ¬ íƒœìŠ¤í¬ ì¤‘ ConnectionErrorë§Œ ê³¨ë¼ì„œ ì²˜ë¦¬
        for e in eg.exceptions:
            logger.warning(f"Network glitch: {e.__notes__}")
            
    except* CriticalError as eg:
        # ì¹˜ëª…ì  ì˜¤ë¥˜ëŠ” ì¦‰ì‹œ ì•Œë¦¼ ë° ì¢…ë£Œ
        await notify_error(eg)
        raise typer.Exit(code=1)

```

### âŒ Bad (Legacy & Silencing)

```python
async def old_style():
    try:
        await do_something()
    except Exception as e: # Too broad
        print(f"Error: {e}") # Traceback ìœ ì‹¤, ë§¥ë½ ì—†ìŒ
        # pass # ìµœì•…ì˜ íŒ¨í„´ (ì—ëŸ¬ ì‚¼í‚¤ê¸°)

```