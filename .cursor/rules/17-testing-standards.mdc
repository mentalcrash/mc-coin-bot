---
description: Pytest Standards for Async/Quant Systems (Mocking, Fixtures)
globs: tests/**/*.py
alwaysApply: false
---

# ğŸ§ª Testing Standards (Pytest & Asyncio)

## 1. Async Testing Core
- **Plugin:** `pytest-asyncio`ë¥¼ ì‚¬ìš©í•˜ë©°, ëª¨ë“  ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ì—ëŠ” `@pytest.mark.asyncio` ë§ˆì»¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. (í˜¹ì€ `pytest.ini`ì˜ `asyncio_mode=auto` í™œìš©)
- **Scope:** ë¹„ë™ê¸° í”½ìŠ¤ì²˜(Fixture)ì˜ ìŠ¤ì½”í”„(`function`, `session`)ë¥¼ ëª…í™•íˆ í•˜ì—¬ ì´ë²¤íŠ¸ ë£¨í”„ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.

## 2. Mocking Strategy (Strict)
- **No Real Network Calls:** ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Unit Test)ì—ì„œëŠ” ì™¸ë¶€ API í˜¸ì¶œì´ **ì—„ê²©íˆ ê¸ˆì§€**ë©ë‹ˆë‹¤.
    - **CCXT Mocking:** `AsyncMock`ì„ ì‚¬ìš©í•˜ì—¬ `exchange.create_order`, `exchange.fetch_ticker` ë“±ì˜ ë°˜í™˜ê°’ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
    - **Pattern:**
        ```python
        from unittest.mock import AsyncMock, MagicMock
        
        @pytest.fixture
        def mock_exchange():
            exchange = AsyncMock()
            # ì •ë°€ë„ í•¨ìˆ˜ëŠ” ë™ê¸°(Sync) ë¡œì§ì¸ ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ side_effect ì²˜ë¦¬ë‚˜ Mock ì„¤ì • ì£¼ì˜
            exchange.amount_to_precision.return_value = "0.001" 
            return exchange
        ```

## 3. Test Coverage & Quality
- **Critical Paths:** ì£¼ë¬¸ ì§‘í–‰(`Execution`), ì‹œê·¸ë„ ìƒì„±(`Strategy`) ëª¨ë“ˆì€ ì»¤ë²„ë¦¬ì§€ 90% ì´ìƒì„ ì§€í–¥í•©ë‹ˆë‹¤.
- **Parametrization:** ë‹¤ì–‘í•œ ì‹œì¥ ìƒí™©(ìƒìŠ¹ì¥, í•˜ë½ì¥, íš¡ë³´ì¥)ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ `pytest.mark.parametrize`ë¥¼ ì ê·¹ í™œìš©í•©ë‹ˆë‹¤.

## 4. Snapshot Testing
- **Data Integrity:** ë³µì¡í•œ ì§€í‘œ ê³„ì‚° ê²°ê³¼ë‚˜ Pydantic ëª¨ë¸ì˜ ì§ë ¬í™” ê²°ê³¼ëŠ” í•˜ë“œì½”ë”©ëœ ê°’ê³¼ ë¹„êµí•˜ê¸°ë³´ë‹¤ `snapshot` í…ŒìŠ¤íŠ¸(ì„ íƒ ì‚¬í•­)ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤.

## 5. Example Pattern

### âœ… Good (Async Mocking)
```python
import pytest
from decimal import Decimal
from unittest.mock import AsyncMock
from src.execution.order_manager import OrderManager

@pytest.mark.asyncio
async def test_place_order_success():
    # Arrange
    mock_exchange = AsyncMock()
    mock_exchange.create_order.return_value = {'id': '123', 'status': 'closed'}
    mock_exchange.amount_to_precision.return_value = "1.0"
    
    manager = OrderManager(exchange=mock_exchange)
    
    # Act
    await manager.place_buy_order("BTC/USDT", Decimal("1.0"))
    
    # Assert
    mock_exchange.create_order.assert_awaited_once()