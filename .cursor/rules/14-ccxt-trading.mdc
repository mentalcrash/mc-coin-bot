---
description: CCXT Pro (WebSocket) Integration Standards & Best Practices
globs: **/exchange/*.py, **/connector/*.py, **/adapters/*.py
alwaysApply: false
---

# ğŸ¦ CCXT Integration Standards (2026 Edition)

## 1. WebSocket First Architecture (CCXT Pro)
- **Library Policy:** 2026ë…„ ê¸°ì¤€ ë¬´ë£Œí™”ëœ **CCXT Pro**ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. REST API(`ccxt.async_support`)ëŠ” ë°±ì—…ìš©ìœ¼ë¡œë§Œ ê³ ë ¤í•©ë‹ˆë‹¤.
    - âœ… `import ccxt.pro as ccxt`
- **Hybrid Strategy:**
    - **Market Data:** ì§€ì—° ì‹œê°„ì´ ì ì€ WebSocket ë©”ì„œë“œ(`watch_ticker`, `watch_order_book`)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - **Order Execution:** ì²´ê²° í™•ì‹¤ì„±ê³¼ íŠ¸ëœì­ì…˜ ì¶”ì ì„ ìœ„í•´ REST API(`create_order`) ì‚¬ìš©ì„ ê¶Œì¥í•˜ì§€ë§Œ, ì´ˆë‹¨íƒ€(HFT)ì˜ ê²½ìš° `ws_create_order`ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.

## 2. Async Lifecycle Management
- **Context Managers:** Exchange ì¸ìŠ¤í„´ìŠ¤ëŠ” ë°˜ë“œì‹œ `async with` ë¸”ë¡ ì•ˆì—ì„œ ìƒì„±í•˜ê³  ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì—°ê²° ëˆ„ìˆ˜(Connection Leak)ë¥¼ ë°©ì§€í•˜ê³  `close()` í˜¸ì¶œì„ ë³´ì¥í•©ë‹ˆë‹¤.
- **Initialization:** ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì§í›„ `await exchange.load_markets()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì‹  ì •ë°€ë„(Precision) ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ê²ƒì€ í•„ìˆ˜ì…ë‹ˆë‹¤.

## 3. Precision & Type Safety (Critical)
- **The "String" Protocol:**
    - CCXT APIì— ê°€ê²©(Price)ì´ë‚˜ ìˆ˜ëŸ‰(Amount)ì„ ì „ë‹¬í•  ë•ŒëŠ” **ë°˜ë“œì‹œ `str` íƒ€ì…**ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    - `float` ì‚¬ìš©ì€ ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ë¡œ ì¸í•´ ì—„ê²©íˆ ê¸ˆì§€ë©ë‹ˆë‹¤.
- **Precision Guards:** ì£¼ë¬¸ í•¨ìˆ˜ í˜¸ì¶œ ì§ì „, ê±°ë˜ì†Œ ê·œê²©ì— ë§ëŠ” ì •ë°€ë„ ë³€í™˜ í•¨ìˆ˜ë¥¼ í†µê³¼ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
    - `safe_amount = exchange.amount_to_precision(symbol, amount)` (Returns `str`)
    - `safe_price = exchange.price_to_precision(symbol, price)` (Returns `str`)

## 4. Error Handling Hierarchy
- **NetworkError / RequestTimeout:** ì¼ì‹œì  ì¥ì• ë¡œ ê°„ì£¼í•˜ê³  **ì¬ì‹œë„(Retry)** ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **ExchangeError / InsufficientFunds:** ë¡œì§ ì˜¤ë¥˜ ë˜ëŠ” ì”ê³  ë¶€ì¡±ì´ë¯€ë¡œ **ì¦‰ì‹œ ì¤‘ë‹¨(Abort)**í•˜ê³  ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
- **DDoSProtection:** `RateLimit` ì´ìŠˆì´ë¯€ë¡œ `backoff` ì‹œê°„ì„ ë‘ê³  ëŒ€ê¸°í•©ë‹ˆë‹¤.

## 5. Unified API Usage
- **Standard Methods:** ê±°ë˜ì†Œ ê³ ìœ ì˜ Implicit API(ì˜ˆ: `binance.fapiPrivate_...`) ì‚¬ìš©ì„ ì§€ì–‘í•˜ê³ , CCXT Unified API(`fetch_ohlcv`, `create_order`)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **Implicit API Exception:** Unified APIê°€ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŠ¹ì • ê¸°ëŠ¥(ì˜ˆ: ë¦¬ìŠ¨í‚¤ ì—°ì¥)ì— í•œí•´ì„œë§Œ Implicit APIë¥¼ í—ˆìš©í•˜ë©°, ì£¼ì„ì„ í•„ìˆ˜ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

## 6. Example Pattern

### âœ… Good (WebSocket & Precision Safe)
```python
import ccxt.pro as ccxt
from decimal import Decimal
from loguru import logger

async def run_market_maker(symbol: str, target_price: Decimal, amount: Decimal):
    # 1. Exchange Config (WebSocket Default)
    exchange_config = {
        'apiKey': 'ENV_VAR',
        'secret': 'ENV_VAR',
        'enableRateLimit': True,
        'options': {'defaultType': 'future'} # ì„ ë¬¼ ê±°ë˜ ëª…ì‹œ
    }

    async with ccxt.binance(exchange_config) as exchange:
        # 2. Essential Metadata Loading
        await exchange.load_markets()
        
        # 3. Precision Handling (Decimal -> String)
        # amount_to_precisionì€ ë‚´ë¶€ì ìœ¼ë¡œ Decimalì„ ì²˜ë¦¬í•˜ì—¬ ì•ˆì „í•œ Stringì„ ë°˜í™˜í•¨
        safe_amount = exchange.amount_to_precision(symbol, amount)
        safe_price = exchange.price_to_precision(symbol, target_price)
        
        try:
            # 4. Hybrid Execution (WS Data + REST Order)
            # ë°ì´í„° ìˆ˜ì‹ ì€ WebSocket
            book = await exchange.watch_order_book(symbol)
            
            # ì£¼ë¬¸ì€ Unified API (REST)
            order = await exchange.create_order(
                symbol=symbol,
                type='limit',
                side='buy',
                amount=safe_amount, # String Passed
                price=safe_price    # String Passed
            )
            logger.info(f"Order Placed: {order['id']}")
            
        except ccxt.InsufficientFunds as e:
            logger.critical(f"Balance Error: {e}")
            raise # Strategy Stop
        except ccxt.NetworkError as e:
            logger.warning(f"Connection unstable: {e}")
            # Retry logic...

```

### âŒ Bad (Sync, Float, Unsafe)

```python
import ccxt

def risky_trade():
    # Sync Library ì‚¬ìš© (Lag ë°œìƒ)
    exchange = ccxt.binance() 
    
    # load_markets ëˆ„ë½ -> ì •ë°€ë„ ì •ë³´ ì—†ìŒ
    
    # Float ì‚¬ìš© ìœ„í—˜ (0.001 -> 0.00099999ë¡œ ì „ì†¡ë  ìˆ˜ ìˆìŒ)
    exchange.create_order('BTC/USDT', 'limit', 'buy', 0.001, 50000.5) 

```

```