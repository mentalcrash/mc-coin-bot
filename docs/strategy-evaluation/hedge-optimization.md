# Hedge Parameter Optimization

8-asset EW TSMOM 포트폴리오에서 `hedge_threshold`과 `hedge_strength_ratio`의 최적 조합을 탐색합니다.

## 실험 설계

### 고정 파라미터 (검증 완료)
```python
TSMOMConfig(
    lookback=30,
    vol_window=30,
    vol_target=0.35,
    annualization_factor=365,
    short_mode=ShortMode.HEDGE_ONLY,
)
PortfolioManagerConfig(max_leverage_cap=2.0)
```

### 스윕 그리드
| 파라미터 | 범위 | 단계 |
|----------|------|------|
| hedge_threshold | -0.05 ~ -0.30 | 8단계 (-0.05, -0.07, -0.10, -0.12, -0.15, -0.20, -0.25, -0.30) |
| hedge_strength_ratio | 0.1 ~ 1.0 | 10단계 (0.1 간격) |
| **총 조합** | **80** | + 2 베이스라인 (DISABLED, FULL) |
| **총 백테스트** | **656** | 82 조합 × 8 에셋 |

### 기간
- 2020-01-01 ~ 2025-12-31 (6년, 2192 candles/asset)

---

## 베이스라인 비교

| 모드 | Sharpe | CAGR | MDD | AnnVol | Calmar | Sortino |
|------|:---:|:---:|:---:|:---:|:---:|:---:|
| DISABLED (Long-Only) | 2.25 | +48.7% | -24.4% | 21.6% | 2.00 | 2.84 |
| FULL (Long/Short) | 1.85 | +47.7% | -27.7% | 25.7% | 1.72 | 2.74 |
| **기존 설정** (-0.07, 0.8) | 2.06 | +48.8% | -23.5% | 23.7% | 2.08 | 3.03 |

**핵심 발견**: Long-Only가 이미 Sharpe 2.25인데, 기존 hedge_strength=0.8은 오히려 Sharpe를 2.06으로 악화시킴.
FULL 모드는 최악 (Sharpe 1.85, MDD -27.7%).

---

## Sharpe Ratio 히트맵

```
hedge_strength_ratio  0.1  0.2  0.3  0.4  0.5  0.6  0.7  0.8  0.9  1.0
hedge_threshold
-0.05                2.30 2.32 2.33 2.31 2.26 2.20 2.14 2.06 1.97 1.85
-0.07                2.30 2.32 2.33 2.31 2.26 2.20 2.14 2.06 1.97 1.85
-0.10                2.30 2.31 2.31 2.29 2.24 2.17 2.11 2.03 1.94 1.82
-0.12                2.30 2.31 2.31 2.29 2.23 2.17 2.10 2.02 1.93 1.81
-0.15                2.29 2.29 2.29 2.26 2.19 2.13 2.06 1.98 1.88 1.76
-0.20                2.30 2.32 2.33 2.32 2.28 2.22 2.17 2.11 2.02 1.92
-0.25                2.30 2.31 2.31 2.30 2.25 2.20 2.15 2.08 2.00 1.90
-0.30                2.29 2.30 2.31 2.30 2.25 2.19 2.14 2.08 2.00 1.91
```

## Calmar Ratio 히트맵

```
hedge_strength_ratio  0.1  0.2  0.3  0.4  0.5  0.6  0.7  0.8  0.9  1.0
hedge_threshold
-0.05                2.15 2.25 2.37 2.42 2.44 2.29 2.18 2.08 1.93 1.72
-0.07                2.15 2.25 2.37 2.42 2.44 2.29 2.18 2.08 1.93 1.72
-0.10                2.15 2.24 2.34 2.38 2.42 2.26 2.15 2.05 1.90 1.69
-0.12                2.15 2.23 2.34 2.36 2.41 2.26 2.14 2.04 1.89 1.68
-0.15                2.12 2.19 2.28 2.28 2.30 2.21 2.09 1.98 1.83 1.63
-0.20                2.14 2.23 2.35 2.37 2.43 2.31 2.20 2.10 1.95 1.75
-0.25                2.13 2.19 2.29 2.29 2.30 2.28 2.17 2.06 1.92 1.72
-0.30                2.11 2.16 2.24 2.21 2.21 2.21 2.15 2.05 1.91 1.71
```

## MDD 히트맵

```
hedge_strength_ratio   0.1   0.2   0.3   0.4   0.5   0.6   0.7   0.8   0.9   1.0
hedge_threshold
-0.05                -22.8 -21.8 -20.7 -20.3 -20.0 -21.2 -22.4 -23.5 -25.1 -27.7
-0.07                -22.8 -21.8 -20.7 -20.3 -20.0 -21.2 -22.4 -23.5 -25.1 -27.7
-0.10                -22.8 -21.8 -20.9 -20.5 -20.0 -21.2 -22.4 -23.5 -25.1 -27.7
-0.12                -22.8 -21.9 -20.8 -20.7 -20.0 -21.2 -22.4 -23.5 -25.1 -27.7
-0.15                -22.9 -22.2 -21.2 -21.1 -20.6 -21.2 -22.4 -23.5 -25.1 -27.7
-0.20                -22.9 -22.0 -20.9 -20.8 -20.2 -21.2 -22.4 -23.5 -25.1 -27.7
-0.25                -23.0 -22.3 -21.4 -21.4 -21.1 -21.2 -22.4 -23.5 -25.1 -27.7
-0.30                -23.2 -22.7 -21.9 -22.1 -22.0 -21.8 -22.4 -23.5 -25.1 -27.7
```

---

## Top 10 (Sharpe 기준)

| threshold | strength | Sharpe | CAGR | MDD | AnnVol | Calmar | Sortino | 총수익 |
|:---------:|:--------:|:------:|:----:|:---:|:------:|:------:|:-------:|:------:|
| **-0.07** | **0.3** | **2.33** | +49.1% | -20.7% | 21.1% | 2.37 | 3.21 | +997% |
| -0.05 | 0.3 | 2.33 | +49.1% | -20.7% | 21.1% | 2.37 | 3.21 | +997% |
| -0.20 | 0.3 | 2.33 | +49.3% | -20.9% | 21.1% | 2.35 | 3.22 | +1006% |
| -0.05 | 0.2 | 2.32 | +49.0% | -21.8% | 21.1% | 2.25 | 3.16 | +992% |
| -0.20 | 0.2 | 2.32 | +49.1% | -22.0% | 21.2% | 2.23 | 3.16 | +998% |
| -0.20 | 0.4 | 2.32 | +49.4% | -20.8% | 21.3% | 2.37 | 3.27 | +1014% |
| -0.07 | 0.2 | 2.32 | +48.9% | -21.8% | 21.1% | 2.25 | 3.16 | +992% |
| -0.25 | 0.2 | 2.31 | +48.9% | -22.3% | 21.2% | 2.19 | 3.13 | +989% |
| -0.12 | 0.3 | 2.31 | +48.8% | -20.8% | 21.1% | 2.34 | 3.19 | +986% |
| -0.10 | 0.3 | 2.31 | +48.8% | -20.9% | 21.1% | 2.34 | 3.20 | +986% |

## Top 5 (Calmar 기준)

| threshold | strength | Sharpe | CAGR | MDD | AnnVol | Calmar | Sortino |
|:---------:|:--------:|:------:|:----:|:---:|:------:|:------:|:-------:|
| -0.05 | 0.5 | 2.26 | +48.8% | **-20.0%** | 21.6% | **2.44** | 3.24 |
| -0.07 | 0.5 | 2.26 | +48.8% | **-20.0%** | 21.6% | **2.44** | 3.24 |
| -0.20 | 0.5 | 2.28 | +49.1% | -20.2% | 21.6% | 2.43 | 3.26 |
| -0.05 | 0.4 | 2.31 | +49.1% | -20.3% | 21.2% | 2.42 | 3.26 |
| -0.07 | 0.4 | 2.31 | +49.1% | -20.3% | 21.3% | 2.42 | 3.26 |

---

## 핵심 분석

### 1. strength_ratio가 지배적 변수

threshold는 성과에 미미한 영향 (같은 strength에서 Sharpe 변동 ±0.04).
**strength_ratio가 결정적**: 0.3에서 Sharpe 피크, 0.5에서 MDD 최소.

```
strength_ratio별 평균 성과 (threshold 평균):
  0.1 → Sharpe 2.30, MDD -22.9%  (너무 약한 헤지)
  0.2 → Sharpe 2.31, MDD -22.1%
  0.3 → Sharpe 2.32, MDD -21.1%  ← Sharpe 최적
  0.4 → Sharpe 2.30, MDD -20.9%
  0.5 → Sharpe 2.24, MDD -20.5%  ← MDD 최적
  0.6 → Sharpe 2.19, MDD -21.3%
  0.7 → Sharpe 2.13, MDD -22.4%
  0.8 → Sharpe 2.05, MDD -23.5%  ← 기존 설정
  0.9 → Sharpe 1.95, MDD -25.1%
  1.0 → Sharpe 1.85, MDD -27.7%  ← FULL과 동일
```

### 2. 기존 설정(0.8)은 과도한 헤지

strength=0.8은 너무 공격적인 숏 포지션으로:
- 변동성 증가 (21.1% → 23.7%)
- MDD 악화 (-20.7% → -23.5%)
- Sharpe 감소 (2.33 → 2.06)

### 3. threshold는 -0.05 ~ -0.20에서 안정적

threshold -0.05와 -0.07이 거의 동일한 성과를 보임.
-0.20도 유사한 수준 → 드로다운이 -5% 이하로 빠질 때 이미 충분한 시그널이 발생.
-0.15에서 소폭 성과 저하 (국부적 변동).

### 4. 최적 영역: strength 0.3~0.5

| 프로파일 | threshold | strength | Sharpe | MDD | Calmar | Sortino |
|----------|:---------:|:--------:|:------:|:---:|:------:|:-------:|
| **Sharpe 최적** | -0.07 | 0.3 | **2.33** | -20.7% | 2.37 | 3.21 |
| **Calmar 최적** | -0.07 | 0.5 | 2.26 | **-20.0%** | **2.44** | 3.24 |
| **균형 (추천)** | -0.07 | 0.4 | 2.31 | -20.3% | 2.42 | **3.26** |
| 기존 설정 | -0.07 | 0.8 | 2.06 | -23.5% | 2.08 | 3.03 |

---

## 최종 결정

### 추천: threshold=-0.07, strength_ratio=0.3

**선정 근거:**
1. **Sharpe 최고** (2.33) — 리스크 대비 수익 극대화
2. **MDD 개선** (-20.7% vs 기존 -23.5%) — 2.8pp 개선
3. **Threshold 안정성** — -0.05, -0.07에서 동일 성과, -0.20에서도 유사
4. **AnnVol 최저** (21.1%) — 변동성 최소
5. 기존 대비 **모든 지표 개선**

### 기존 대비 개선폭

| 지표 | 기존 (0.07, 0.8) | 최적 (0.07, 0.3) | 변화 |
|------|:-----------------:|:-----------------:|:----:|
| Sharpe | 2.06 | **2.33** | **+13.1%** |
| CAGR | +48.8% | **+49.1%** | +0.3pp |
| MDD | -23.5% | **-20.7%** | **+2.8pp** |
| AnnVol | 23.7% | **21.1%** | **-2.6pp** |
| Calmar | 2.08 | **2.37** | **+13.9%** |
| Sortino | 3.03 | **3.21** | **+5.9%** |
| 총수익 | +984% | **+997%** | +13pp |

### vs 베이스라인 (Long-Only)

| 지표 | DISABLED | 최적 HEDGE | 변화 |
|------|:--------:|:----------:|:----:|
| Sharpe | 2.25 | **2.33** | **+3.6%** |
| CAGR | +48.7% | **+49.1%** | +0.4pp |
| MDD | -24.4% | **-20.7%** | **+3.7pp** |
| Calmar | 2.00 | **2.37** | **+18.5%** |

---

## 최종 확정 설정

```python
TSMOMConfig(
    lookback=30,
    vol_window=30,
    vol_target=0.35,
    annualization_factor=365,
    short_mode=ShortMode.HEDGE_ONLY,
    hedge_threshold=-0.07,        # -7% 드로다운 시 헤지 활성화
    hedge_strength_ratio=0.3,     # 롱 시그널의 30%로 숏 진입 (기존 80%)
)
```

### 해석
- 드로다운이 -7% 이하일 때 숏 헤지 활성화
- 숏 강도는 롱 시그널의 30%만 사용 (약한 보호적 숏)
- "방어적 숏"이지 "공격적 숏"이 아님
- 이 설정은 **Long-Only보다 MDD 3.7pp 개선, Sharpe 3.6% 개선**

---

## 부록: 스크립트

```bash
uv run python scripts/multi_asset_hedge_sweep.py
```

- 결과 CSV: `data/multi_asset_hedge_sweep.csv`
- 베이스라인 CSV: `data/multi_asset_hedge_baselines.csv`
