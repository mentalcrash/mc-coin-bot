groups:
  - name: mc-coin-bot
    rules:
      # 1. 낙폭 10% 초과 — 1분 유지
      - alert: HighDrawdown
        expr: mcbot_drawdown_pct > 10
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High drawdown detected ({{ $value | printf \"%.1f\" }}%)"
          description: "Portfolio drawdown has exceeded 10% for over 1 minute. Current: {{ $value | printf \"%.1f\" }}%"

      # 2. 거래소 API 5회 연속 실패
      - alert: APIUnhealthy
        expr: mcbot_exchange_consecutive_failures >= 5
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Exchange API unhealthy ({{ $value }} consecutive failures)"
          description: "Binance API has failed {{ $value }} consecutive times. Order execution may be blocked."

      # 3. 이벤트 드롭 발생
      - alert: EventsDropped
        expr: rate(mcbot_eventbus_events_dropped_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "EventBus events being dropped"
          description: "Events are being dropped due to queue backpressure. Rate: {{ $value | printf \"%.2f\" }}/s"

      # 4. WebSocket 끊김 — 2분 이상
      - alert: WSDisconnected
        expr: mcbot_exchange_ws_connected == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "WebSocket disconnected for {{ $labels.symbol }}"
          description: "WebSocket connection for {{ $labels.symbol }} has been down for over 2 minutes. Market data feed interrupted."

      # 5. 슬리피지 P95 > 20bp
      - alert: HighSlippage
        expr: histogram_quantile(0.95, rate(mcbot_slippage_bps_bucket[15m])) > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High slippage detected (P95: {{ $value | printf \"%.1f\" }} bps)"
          description: "Order execution slippage P95 exceeds 20 basis points. Execution quality may be degraded."

      # 6. EventBus 큐 50% 이상 사용
      - alert: QueueCongestion
        expr: mcbot_eventbus_queue_depth > 5000
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "EventBus queue congested ({{ $value }} events pending)"
          description: "EventBus queue depth exceeds 5000 (50% of default 10000). Backpressure risk."

      # 7. Event Loop Lag — 1초 초과 1분 유지
      - alert: HighEventLoopLag
        expr: mcbot_event_loop_lag_seconds > 1.0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High event loop lag ({{ $value | printf \"%.2f\" }}s)"
          description: "Event loop scheduling lag exceeds 1 second. Possible CPU saturation or blocking I/O."

      # 8. RSS 메모리 2GB 초과 — 5분 유지
      - alert: HighMemoryUsage
        expr: mcbot_process_memory_rss_bytes > 2147483648
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage ({{ $value | humanize1024 }})"
          description: "Process RSS memory exceeds 2GB for over 5 minutes. Possible memory leak."

      # 9. Open FD 1000개 초과 — 2분 유지
      - alert: HighFDCount
        expr: mcbot_process_open_fds > 1000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High file descriptor count ({{ $value }})"
          description: "Process has {{ $value }} open file descriptors (threshold: 1000). Possible resource leak."

      # 10. WS 빈번한 재연결 — 5분간 3회 이상
      - alert: WSFrequentReconnects
        expr: increase(mcbot_ws_reconnects_total[5m]) >= 3
        labels:
          severity: warning
        annotations:
          summary: "Frequent WS reconnects for {{ $labels.symbol }} ({{ $value | printf \"%.0f\" }} in 5m)"
          description: "WebSocket for {{ $labels.symbol }} reconnected {{ $value | printf \"%.0f\" }} times in 5 minutes. Network instability suspected."

      # 11. WS 메시지 수신 중단 — 60초 이상
      - alert: WSNoMessages
        expr: mcbot_ws_last_message_age_seconds > 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No WS messages for {{ $labels.symbol }} ({{ $value | printf \"%.0f\" }}s)"
          description: "No WebSocket messages received for {{ $labels.symbol }} in {{ $value | printf \"%.0f\" }} seconds. Data feed may be stale."

      # 12. Distribution Drift — p-value < 0.05 for 1 day
      - alert: DistributionDrift
        expr: mcbot_distribution_p_value < 0.05
        for: 1d
        labels:
          severity: warning
        annotations:
          summary: "Distribution drift detected for {{ $labels.strategy }} (p={{ $value | printf \"%.4f\" }})"
          description: "KS test p-value below 0.05 for over 1 day. Live return distribution may have shifted from backtest reference."

      # 13. Structural Decay — WARNING tier (slope<=0 OR conformal breach)
      - alert: StructuralDecay
        expr: mcbot_ransac_decay_detected == 1
        for: 1d
        labels:
          severity: warning
        annotations:
          summary: "Structural decay detected for {{ $labels.strategy }}"
          description: "Conformal-RANSAC detector indicates structural performance decay (slope <= 0 or conformal bound breach)."

      # 13b. Structural Decay — CRITICAL tier (slope<=0 AND conformal breach)
      - alert: StructuralDecayCritical
        expr: mcbot_ransac_slope <= 0 and mcbot_ransac_current_cumulative < mcbot_ransac_conformal_lower
        for: 1d
        labels:
          severity: critical
        annotations:
          summary: "Critical structural decay for {{ $labels.strategy }}"
          description: "RANSAC slope <= 0 AND cumulative return below conformal lower bound. Strategy may have lost its edge."

      # 12b. Distribution Drift — CRITICAL tier (p-value < 0.01 for 1 day)
      - alert: DistributionDriftCritical
        expr: mcbot_distribution_p_value < 0.01 and mcbot_distribution_p_value > 0
        for: 1d
        labels:
          severity: critical
        annotations:
          summary: "Critical distribution drift for {{ $labels.strategy }} (p={{ $value | printf \"%.4f\" }})"
          description: "KS test p-value below 0.01 for over 1 day. Live return distribution has significantly shifted from backtest reference."

      # 12c. GBM Drawdown — WARNING (depth OR duration > 95% CI)
      - alert: GBMDrawdownWarning
        expr: mcbot_gbm_severity == 1
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "GBM drawdown warning for {{ $labels.strategy }}"
          description: "Drawdown depth OR duration exceeds 95% GBM CI. Current depth: {{ with printf \"mcbot_gbm_drawdown_depth{strategy='%s'}\" $labels.strategy | query }}{{ . | first | value | printf \"%.2f\" }}{{ end }}"

      # 12d. GBM Drawdown — CRITICAL (depth AND duration > 95% CI)
      - alert: GBMDrawdownCritical
        expr: mcbot_gbm_severity == 2
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Critical GBM drawdown for {{ $labels.strategy }}"
          description: "Drawdown depth AND duration both exceed 95% GBM CI. Immediate review recommended."

      # 12e. Execution Anomaly — Low fill rate
      - alert: ExecutionLowFillRate
        expr: mcbot_execution_fill_rate < 0.8 and mcbot_execution_fill_rate > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low execution fill rate ({{ $value | printf \"%.1f\" }}%)"
          description: "1h fill rate below 80%. Execution quality may be degraded."

      # 12f. Execution Anomaly — Consecutive rejections
      - alert: ExecutionConsecutiveRejections
        expr: mcbot_execution_consecutive_rejections >= 5
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Consecutive order rejections ({{ $value | printf \"%.0f\" }})"
          description: "{{ $value | printf \"%.0f\" }} consecutive order rejections. Order execution may be blocked."

      # 14. On-chain fetch 실패율 50% 초과 — 24시간 기준, 1시간 유지
      - alert: OnchainFetchHighFailureRate
        expr: >-
          rate(mcbot_onchain_fetch_total{status="failure"}[24h])
          / rate(mcbot_onchain_fetch_total[24h]) > 0.5
          and rate(mcbot_onchain_fetch_total[24h]) > 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "On-chain fetch failure rate > 50% ({{ $value | printf \"%.0f\" }}%)"
          description: "On-chain data fetch failure rate exceeds 50% over the last 24 hours. External API may be down."

      # 15. On-chain 데이터 48시간 이상 미갱신
      - alert: OnchainDataStale
        expr: time() - mcbot_onchain_last_success_timestamp > 172800
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "On-chain data stale for {{ $labels.source }} (> 48h)"
          description: "Source {{ $labels.source }} has not been updated for over 48 hours. Manual ingestion may be needed."

      # 16. Live 캐시에 on-chain 컬럼 0개 — 30분 유지
      - alert: OnchainCacheEmpty
        expr: mcbot_onchain_cache_size == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "On-chain cache empty for {{ $labels.symbol }}"
          description: "Live on-chain cache has 0 columns for {{ $labels.symbol }} for over 30 minutes. Check silver data and LiveOnchainFeed."

      # 17. On-chain fetch P95 지연시간 60초 초과
      - alert: OnchainFetchSlow
        expr: histogram_quantile(0.95, rate(mcbot_onchain_fetch_latency_seconds_bucket[1h])) > 60
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "On-chain fetch slow (P95: {{ $value | printf \"%.1f\" }}s)"
          description: "On-chain data fetch P95 latency exceeds 60 seconds. Network or API performance degradation."

      # 18. 읽기 API 실패율 — 5분간 0.1/s 초과, 2분 유지
      - alert: APIReadFailures
        expr: rate(mcbot_exchange_api_calls_total{endpoint=~"fetch_.*", status="failure"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Read API failures detected ({{ $value | printf \"%.2f\" }}/s)"
          description: "Exchange read API (fetch_positions, fetch_balance, etc.) failure rate exceeds 0.1/s for over 2 minutes. Data freshness may be degraded."

      # 19. API 지연시간 P95 > 5초 — 2분 유지
      - alert: APILatencyHigh
        expr: histogram_quantile(0.95, rate(mcbot_exchange_api_latency_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "API latency high (P95: {{ $value | printf \"%.1f\" }}s)"
          description: "Exchange API P95 latency exceeds 5 seconds. Order execution quality may be degraded. Includes retry backoff time."

      # 20. Rate limit 75% 접근 — 1분 유지
      - alert: APIRateLimitApproaching
        expr: sum(rate(mcbot_exchange_api_calls_total[1m])) * 60 > 900
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "API rate limit approaching ({{ $value | printf \"%.0f\" }} req/min)"
          description: "Exchange API call rate exceeds 900 req/min (75% of Binance 1200 req/min limit). Reduce API call frequency to avoid IP ban."

      # 21. 봇 재시작 감지 (uptime 리셋)
      - alert: BotRestarted
        expr: resets(mcbot_uptime_seconds[10m]) > 0
        labels:
          severity: warning
        annotations:
          summary: "Bot restarted (uptime reset detected)"
          description: "mcbot_uptime_seconds gauge was reset in the last 10 minutes. Possible OOM kill, crash, or manual restart."

      # 22. Heartbeat 120초 이상 미갱신 — event loop hung 감지
      - alert: HeartbeatStale
        expr: time() - mcbot_heartbeat_timestamp > 120
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Heartbeat stale ({{ $value | printf \"%.0f\" }}s since last)"
          description: "No heartbeat received for over 120 seconds. Event loop may be hung or bot process unresponsive."

      # 23. Handler 에러율 — 5분간 0.01/s 초과, 2분 유지
      - alert: HandlerErrorsHigh
        expr: rate(mcbot_eventbus_handler_errors_total[5m]) > 0.01
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Handler errors elevated ({{ $value | printf \"%.3f\" }}/s)"
          description: "EventBus handler error rate exceeds 0.01/s for over 2 minutes. Event chain may be disrupted."

      # 24. Circuit Breaker 발동 — 즉시 알림
      - alert: CircuitBreakerTriggered
        expr: increase(mcbot_circuit_breaker_total[5m]) > 0
        labels:
          severity: critical
        annotations:
          summary: "Circuit breaker triggered!"
          description: "System stop-loss circuit breaker fired. All positions are being liquidated. Immediate attention required."

      # 25. EventBus 큐 80% 초과 — CRITICAL 에스컬레이션
      - alert: QueueCongestionCritical
        expr: mcbot_eventbus_queue_depth > 8000
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "EventBus queue critically congested ({{ $value }} events pending)"
          description: "EventBus queue depth exceeds 8000 (80% of default 10000). Imminent event drops. Investigate handler bottleneck immediately."

      # 26. 전략별 누적 realized PnL -$500 이하 — 1시간 유지
      - alert: StrategyPnlNegative
        expr: mcbot_strategy_pnl_usdt < -500
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Strategy {{ $labels.strategy }} realized PnL below -$500 ({{ $value | printf \"%.2f\" }})"
          description: "전략별 누적 realized PnL이 -$500 이하로 1시간 지속"

      # 27. 전략 시그널 24시간 미발생
      - alert: StrategySignalSilent
        expr: rate(mcbot_strategy_signals_total[6h]) == 0
        for: 1d
        labels:
          severity: warning
        annotations:
          summary: "Strategy {{ $labels.strategy }} emitted no signals for 1 day"
          description: "전략이 24시간 시그널 미발생. 데이터 피드 문제 또는 전략 로직 확인 필요"

      # 28. CPU 사용률 80% 초과 — 2분 유지
      - alert: HighCPUUsage
        expr: mcbot_process_cpu_percent > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage ({{ $value | printf \"%.1f\" }}%)"
          description: "Process CPU usage exceeds 80% for over 2 minutes. Possible compute-bound handler or blocking I/O."

      # 29. Active asyncio tasks 200개 초과 — 5분 유지
      - alert: HighTaskCount
        expr: mcbot_active_tasks > 200
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High active task count ({{ $value | printf \"%.0f\" }})"
          description: "Number of active asyncio tasks exceeds 200 for over 5 minutes. Possible task leak."

      # 30. GC Gen2 수집 빈도 — 5분간 rate > 0.1
      - alert: HighGCPressure
        expr: rate(mcbot_process_gc_collections_total{generation="2"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High GC pressure (gen2 rate: {{ $value | printf \"%.3f\" }}/s)"
          description: "Generation 2 GC collection rate exceeds 0.1/s for over 5 minutes. Large object churn may cause event loop lag spikes."

      # 31. Netting 상쇄 비율 급락
      - alert: NettingLowOffset
        expr: mcbot_netting_offset_ratio < 0.1 and mcbot_netting_gross_exposure > 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Low netting offset ratio ({{ $value | printf \"%.2f\" }})"
          description: "Pod간 포지션 상쇄 비율이 10% 미만. 방향성 편중 위험."

      # 32. Pod Probation 진입
      - alert: PodInProbation
        expr: mcbot_pod_lifecycle_state{mcbot_pod_lifecycle_state="probation"} == 1
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod_id }} entered probation"
          description: "Pod가 probation 상태에 진입. 유예 기간 내 미회복 시 RETIRED 전환."

      # 33. Gross exposure 과다
      - alert: HighGrossExposure
        expr: mcbot_netting_gross_exposure > 3.0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High gross exposure ({{ $value | printf \"%.2f\" }})"
          description: "Pod간 총 gross exposure 3.0 초과. 레버리지 과다 위험."

      # 34. 과도 레버리지 — 강제 청산 위험
      - alert: HighAggregateLeverage
        expr: mcbot_aggregate_leverage > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Aggregate leverage dangerously high ({{ $value | printf \"%.1f\" }}x)"
          description: "Portfolio aggregate leverage exceeds 5x for over 1 minute. Liquidation risk elevated."

      # 35. Live API 차단 — 무음 주문 차단 감지
      - alert: LiveAPIBlocked
        expr: increase(mcbot_live_api_blocked_total[5m]) > 0
        labels:
          severity: critical
        annotations:
          summary: "Live orders blocked due to unhealthy API ({{ $value | printf \"%.0f\" }} in 5m)"
          description: "Orders are being silently blocked because exchange API is unhealthy. Check APIUnhealthy alert and network status."

      # 36. 마진 사용률 80% 초과 — margin call 사전 경고
      - alert: HighMarginUtilization
        expr: mcbot_margin_used_usdt / mcbot_equity_usdt > 0.8 and mcbot_equity_usdt > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High margin utilization ({{ $value | printf \"%.1f\" }}%)"
          description: "Margin utilization exceeds 80% for over 2 minutes. Margin call risk. Reduce position sizes or add margin."

      # 37. Thread 수 과다 — thread leak 감지
      - alert: HighThreadCount
        expr: mcbot_process_thread_count > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High thread count ({{ $value | printf \"%.0f\" }})"
          description: "Process thread count exceeds 50 for over 5 minutes. Possible thread leak from ThreadPoolExecutor or blocking I/O."

      # 38. Fill 파싱 실패 — 포지션 추적 부정확 위험
      - alert: LiveFillParseFailure
        expr: increase(mcbot_live_fill_parse_failure_total[5m]) > 0
        labels:
          severity: warning
        annotations:
          summary: "Fill parse failure detected ({{ $value | printf \"%.0f\" }} in 5m)"
          description: "Exchange fill response parsing failed. Position tracking may be inaccurate. Check exchange API response format changes."

      # 39. MIN_NOTIONAL 빈번 스킵 — allocation 조정 필요
      - alert: LiveFrequentMinNotionalSkip
        expr: increase(mcbot_live_min_notional_skip_total[1h]) >= 3
        labels:
          severity: info
        annotations:
          summary: "Frequent MIN_NOTIONAL skips ({{ $value | printf \"%.0f\" }} in 1h)"
          description: "MIN_NOTIONAL threshold skipped 3+ times in 1 hour. Consider adjusting allocation or minimum order size for affected symbols."

      # 40. Surveillance 스캔 지연 (10.5일 초과)
      - alert: SurveillanceScanStale
        expr: time() - mcbot_surveillance_last_scan_timestamp > 907200
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Surveillance scan overdue (>10.5 days)"
          description: "Market surveillance scan has not completed in over 10.5 days. Check scan task health."

      # 41. Surveillance 유니버스 과소 (5개 미만)
      - alert: SurveillanceUniverseTooSmall
        expr: mcbot_surveillance_active_assets < 5 and mcbot_surveillance_active_assets > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Surveillance universe has fewer than 5 assets ({{ $value | printf \"%.0f\" }})"
          description: "Market surveillance universe is critically small. Check volume filters and market conditions."
