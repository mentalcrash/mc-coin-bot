groups:
  - name: mc-coin-bot
    rules:
      # 1. 낙폭 10% 초과 — 1분 유지
      - alert: HighDrawdown
        expr: mcbot_drawdown_pct > 10
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High drawdown detected ({{ $value | printf \"%.1f\" }}%)"
          description: "Portfolio drawdown has exceeded 10% for over 1 minute. Current: {{ $value | printf \"%.1f\" }}%"

      # 2. 거래소 API 5회 연속 실패
      - alert: APIUnhealthy
        expr: mcbot_exchange_consecutive_failures >= 5
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Exchange API unhealthy ({{ $value }} consecutive failures)"
          description: "Binance API has failed {{ $value }} consecutive times. Order execution may be blocked."

      # 3. 이벤트 드롭 발생
      - alert: EventsDropped
        expr: rate(mcbot_eventbus_events_dropped_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "EventBus events being dropped"
          description: "Events are being dropped due to queue backpressure. Rate: {{ $value | printf \"%.2f\" }}/s"

      # 4. WebSocket 끊김 — 2분 이상
      - alert: WSDisconnected
        expr: mcbot_exchange_ws_connected == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "WebSocket disconnected for {{ $labels.symbol }}"
          description: "WebSocket connection for {{ $labels.symbol }} has been down for over 2 minutes. Market data feed interrupted."

      # 5. 슬리피지 P95 > 20bp
      - alert: HighSlippage
        expr: histogram_quantile(0.95, rate(mcbot_slippage_bps_bucket[15m])) > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High slippage detected (P95: {{ $value | printf \"%.1f\" }} bps)"
          description: "Order execution slippage P95 exceeds 20 basis points. Execution quality may be degraded."

      # 6. EventBus 큐 50% 이상 사용
      - alert: QueueCongestion
        expr: mcbot_eventbus_queue_depth > 5000
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "EventBus queue congested ({{ $value }} events pending)"
          description: "EventBus queue depth exceeds 5000 (50% of default 10000). Backpressure risk."

      # 7. Event Loop Lag — 1초 초과 1분 유지
      - alert: HighEventLoopLag
        expr: mcbot_event_loop_lag_seconds > 1.0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High event loop lag ({{ $value | printf \"%.2f\" }}s)"
          description: "Event loop scheduling lag exceeds 1 second. Possible CPU saturation or blocking I/O."

      # 8. RSS 메모리 2GB 초과 — 5분 유지
      - alert: HighMemoryUsage
        expr: mcbot_process_memory_rss_bytes > 2147483648
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage ({{ $value | humanize1024 }})"
          description: "Process RSS memory exceeds 2GB for over 5 minutes. Possible memory leak."

      # 9. Open FD 1000개 초과 — 2분 유지
      - alert: HighFDCount
        expr: mcbot_process_open_fds > 1000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High file descriptor count ({{ $value }})"
          description: "Process has {{ $value }} open file descriptors (threshold: 1000). Possible resource leak."

      # 10. WS 빈번한 재연결 — 5분간 3회 이상
      - alert: WSFrequentReconnects
        expr: increase(mcbot_ws_reconnects_total[5m]) >= 3
        labels:
          severity: warning
        annotations:
          summary: "Frequent WS reconnects for {{ $labels.symbol }} ({{ $value | printf \"%.0f\" }} in 5m)"
          description: "WebSocket for {{ $labels.symbol }} reconnected {{ $value | printf \"%.0f\" }} times in 5 minutes. Network instability suspected."

      # 11. WS 메시지 수신 중단 — 60초 이상
      - alert: WSNoMessages
        expr: mcbot_ws_last_message_age_seconds > 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No WS messages for {{ $labels.symbol }} ({{ $value | printf \"%.0f\" }}s)"
          description: "No WebSocket messages received for {{ $labels.symbol }} in {{ $value | printf \"%.0f\" }} seconds. Data feed may be stale."

      # 12. Distribution Drift — p-value < 0.05 for 1 day
      - alert: DistributionDrift
        expr: mcbot_distribution_p_value < 0.05
        for: 1d
        labels:
          severity: warning
        annotations:
          summary: "Distribution drift detected for {{ $labels.strategy }} (p={{ $value | printf \"%.4f\" }})"
          description: "KS test p-value below 0.05 for over 1 day. Live return distribution may have shifted from backtest reference."

      # 13. Structural Decay — RANSAC decay detected for 1 day
      - alert: StructuralDecay
        expr: mcbot_ransac_decay_detected == 1
        for: 1d
        labels:
          severity: critical
        annotations:
          summary: "Structural decay detected for {{ $labels.strategy }}"
          description: "Conformal-RANSAC detector indicates structural performance decay (slope <= 0 or conformal bound breach)."

      # 14. On-chain fetch 실패율 50% 초과 — 24시간 기준, 1시간 유지
      - alert: OnchainFetchHighFailureRate
        expr: rate(mcbot_onchain_fetch_total{status="failure"}[24h]) / rate(mcbot_onchain_fetch_total[24h]) > 0.5
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "On-chain fetch failure rate > 50% ({{ $value | printf \"%.0f\" }}%)"
          description: "On-chain data fetch failure rate exceeds 50% over the last 24 hours. External API may be down."

      # 15. On-chain 데이터 48시간 이상 미갱신
      - alert: OnchainDataStale
        expr: time() - mcbot_onchain_last_success_timestamp > 172800
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "On-chain data stale for {{ $labels.source }} (> 48h)"
          description: "Source {{ $labels.source }} has not been updated for over 48 hours. Manual ingestion may be needed."

      # 16. Live 캐시에 on-chain 컬럼 0개 — 30분 유지
      - alert: OnchainCacheEmpty
        expr: mcbot_onchain_cache_size == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "On-chain cache empty for {{ $labels.symbol }}"
          description: "Live on-chain cache has 0 columns for {{ $labels.symbol }} for over 30 minutes. Check silver data and LiveOnchainFeed."

      # 17. On-chain fetch P95 지연시간 60초 초과
      - alert: OnchainFetchSlow
        expr: histogram_quantile(0.95, rate(mcbot_onchain_fetch_latency_seconds_bucket[1h])) > 60
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "On-chain fetch slow (P95: {{ $value | printf \"%.1f\" }}s)"
          description: "On-chain data fetch P95 latency exceeds 60 seconds. Network or API performance degradation."
